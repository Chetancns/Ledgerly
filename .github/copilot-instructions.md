# Ledgerly AI Assistant Playbook

- **Repo layout**: `ledgerly-api/` NestJS + TypeORM backend (PostgreSQL, schema `dbo`); `ledgerly_app/` Next.js 15 + React 19 + Tailwind frontend; docs live in `/docs` (Architecture, Development, API, DB schema, Troubleshooting).
- **Dev servers**: backend `npm run start:dev` on 3001; frontend `npm run dev` on 3000; Windows shortcut `./start-apps.bat` to run both. Production: backend `npm run build && npm run start:prod`; frontend `npm run build && npm start`.
- **Env setup**: backend `.env` requires DB_* (host/port/user/pass/name), `DB_SSL`, `JWT_SECRET`, `JWT_EXPIRES`, `PORT`, `NODE_ENV`, optional `OPENAI_API_KEY`, `FRONTEND_ORIGIN` (comma list of allowed origins, validated in `src/main.ts` with fallback to localhost/Vercel). Frontend `.env.local` needs `NEXT_PUBLIC_API_BASE_URL` (defaults to `http://192.168.1.50:3001` if missing) and `NODE_ENV`.
- **CORS/CSRF/auth**: Backend enables CORS with `credentials:true` and whitelisted origins; cookies carry JWT/refresh. CSRF middleware (`src/middlewares/csrf.middleware.ts`) issues/rotates `XSRF-TOKEN` on every GET and requires `X-CSRF-Token` header for unsafe methods. Frontend axios client (`src/services/api.ts`) auto-calls `initCsrf` before POST/PUT/PATCH/DELETE and injects the header + cookie. 401s trigger `/auth/refresh` retry; on refresh failure it clears client state and redirects to `/login`. Avoid manual token storage—use provided services/hooks.
- **Frontend patterns**: Pages in `src/pages`, shared UI in `src/components` (e.g., `Layout.tsx` handles nav, theme, notifications, FAB for uploads). API calls live in `src/services/*` (wrap `api.ts` client). Auth flow uses `useAuth` hook (`src/hooks/useAuth.ts`) which calls `/auth/me` on mount and exposes `doLogin`, `doSignup`, `logoutapi`, `refreshUser`. Keep new API interactions inside `src/services` and consume via hooks.
- **AI features**: Receipt OCR and audio parsing are wired through `UploadReceipt`/`UploadAudio` components using `uploadReceiptImage`/`uploadAudioFile` (see `src/services/ai.ts`). Backend AI routes sit under `/ai` module; expect longer latencies—surface toast states like existing flow in `Layout.tsx`.
- **Database & migrations**: TypeORM datasource in `data-source.ts` sets schema `dbo` and points migrations to `dist/migrations/*.js`. After entity changes: `npm run migration:generate` then `npm run migration:run`; use `npm run migration:revert` to roll back. Do not enable synchronize in production.
- **Testing & quality**: Backend: `npm run test`, `npm run test:e2e`, `npm run test:cov`, `npm run lint`, `npm run format`. Frontend: `npm run lint`, `npm run type-check`, `npm run test` (if configured). Run lint/type-check before PRs.
- **API surface (quick)**: Auth `/auth/login|register|refresh|me|logout`; CRUD modules follow plural nouns (`/transactions`, `/accounts`, `/categories`, `/budgets`, `/debts`, `/recurring`); reports under `/reports/*`; AI under `/ai/parse-transaction`, `/ai/image`, `/ai/audio`. Use `src/services` as reference for payload shapes.
- **Docs to consult first**: `/docs/QUICK_REFERENCE.md` (commands), `/docs/DEVELOPMENT.md` (setup, workflows), `/docs/ARCHITECTURE.md` (module map, data flows), `/docs/API_REFERENCE.md` (request/response), `/docs/DATABASE_SCHEMA.md` (tables, relations). Update relevant doc + `CHANGELOG.md` when changing behavior.
- **Common pitfalls**: Missing `FRONTEND_ORIGIN` causes CORS fallback warning; set proper origins for deployed hosts. CSRF header mismatches return 403—ensure requests go through `api.ts`. DB schema fixed to `dbo`; adjust queries/migrations accordingly. Keep `withCredentials` true on axios calls.
